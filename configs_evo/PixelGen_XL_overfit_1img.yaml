# PixelGen Evolutionary Training - OVERFIT 1 IMAGE
#
# Debug config to verify training works by overfitting to a single image.
# If this doesn't work, the training loop has fundamental issues.

# ============================================================================
# MODEL CONFIGURATION
# ============================================================================
model:
  denoiser:
    model_name: "JiT-L/16"
    input_size: 256
    patch_size: 16
    hidden_size: 1024
    depth: 24
    num_heads: 16
    mlp_ratio: 4.0
    num_classes: 1
    in_context_len: 32
    in_context_start: 8
    bottleneck_dim: 128
    use_bottleneck: true

  scheduler:
    type: "linear"

# ============================================================================
# DATA - SINGLE IMAGE OVERFIT
# ============================================================================
data:
  dataset_type: "overfit"     # Special mode: repeat single image
  train_data_dir: "/home/johndpope/Documents/GitHub/hrr-titans/data/celeba/img_align_celeba"
  num_images: 1               # Only use 1 image
  train_batch_size: 2         # Reduced for limited GPU memory
  train_num_workers: 0        # No workers needed for 1 image
  img_size: 256
  center_crop: true

# ============================================================================
# EVOLUTION - AGGRESSIVE FOR OVERFITTING
# ============================================================================
evolution:
  population_size: 8
  num_generations: 500        # Should overfit within 100-200 gens

  # Higher noise for faster exploration
  noise_scale: 0.02
  noise_decay: 0.99
  noise_min: 0.0001

  # CRITICAL: threshold must be 1 since each seed gets only 1 vote!
  vote_threshold: 1           # Each seed votes -1, 0, or +1
  update_scale: 0.0001        # Small learning rate with proper ES gradient

  # Small batches for overfitting (reduced for limited GPU memory)
  eval_batch_size: 2
  num_eval_batches: 1

  # Frequent logging to watch progress
  checkpoint_every: 50
  log_every: 5
  log_images_every: 10        # Log images frequently
  num_sample_images: 4
  sample_steps: 20

  patience: 200
  min_improvement: 0.0001

  fitness:
    w_flow_matching: 0.40     # Higher FM weight for reconstruction
    w_lpips: 0.30
    w_dino: 0.20
    w_ssim: 0.10
    percept_t_threshold: 0.2

# ============================================================================
# LAYER SELECTION - EVOLVE MORE FOR OVERFITTING
# ============================================================================
layer_selection:
  evolve_final_layer: true
  evolve_in_context_tokens: true
  evolve_late_attention: true
  evolve_adaln_modulation: true
  evolve_mlp: true            # Enable MLP for overfitting
  evolve_embedders: false
  evolve_patch_embed: false
  num_late_layers: 6
  evolve_qkv: true
  evolve_proj: true

# ============================================================================
# HARDWARE
# ============================================================================
hardware:
  device: "cuda"
  dtype: "bfloat16"
  seed: 42
  empty_cache_freq: 5
